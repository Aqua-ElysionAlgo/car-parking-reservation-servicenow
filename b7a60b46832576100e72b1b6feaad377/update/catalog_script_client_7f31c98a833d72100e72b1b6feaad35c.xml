<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="catalog_script_client">
    <catalog_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_catalog>true</applies_catalog>
        <applies_extended>false</applies_extended>
        <applies_req_item>false</applies_req_item>
        <applies_sc_task>false</applies_sc_task>
        <applies_target_record>false</applies_target_record>
        <applies_to>item</applies_to>
        <cat_item display_value="Car parking reservation">f839d7ca83a576100e72b1b6feaad38b</cat_item>
        <cat_variable>IO:b99a9b8e83a576100e72b1b6feaad3f4</cat_variable>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>true</isolate_script>
        <messages/>
        <name>Total Fee (Baht) End Date/Time</name>
        <order/>
        <published_ref/>
        <script><![CDATA[function onChange(control, oldValue, newValue, isLoading) {
  if (isLoading) return;

  var startStr = g_form.getValue('cpr_start_datetime');
  var endStr   = g_form.getValue('cpr_end_datetime');

  // ถ้ายังไม่กรอกครบ ให้ล้างค่า
  if (!startStr || !endStr) {
    g_form.setValue('cpr_total_fee', '');
    return;
  }

  // ใช้ moment (ใน Service Portal มักมีอยู่แล้ว)
  var start = moment(startStr, "YYYY-MM-DD HH:mm:ss", true);
  var end   = moment(endStr,   "YYYY-MM-DD HH:mm:ss", true);

  if (!start.isValid() || !end.isValid()) {
    g_form.setValue('cpr_total_fee', '');
    return;
  }

  // End ต้องมากกว่า Start
  if (!end.isAfter(start)) {
    g_form.setValue('cpr_total_fee', '');
    g_form.showFieldMsg('cpr_end_datetime', 'End Date/Time ต้องมากกว่า Start Date/Time', 'error');
    return;
  } else {
    g_form.hideFieldMsg('cpr_end_datetime', true);
  }

  // คิดเงินแบบ "ขึ้นวันใหม่เริ่มคิดใหม่"
  var totalFee = 0;
  var cursor = start.clone();

  while (cursor.isBefore(end)) {
    // ตัดช่วงเป็นรายวัน (ถึง 23:59:59 ของวันนั้น หรือถึง end)
    var endOfDay = cursor.clone().endOf('day');
    var segmentEnd = moment.min(end, endOfDay.add(1, 'seconds')); // ให้รวมวินาทีสุดท้ายของวัน

    var diffMinutes = segmentEnd.diff(cursor, 'minutes', true);
    var hours = Math.ceil(diffMinutes / 60); // ปัดขึ้นเป็นชั่วโมง

    totalFee += calcDailyFee(hours);

    cursor = segmentEnd.clone();
  }

  // ใส่ค่า Total Fee (ให้เป็นทศนิยม 2 ตำแหน่ง)
  g_form.setValue('cpr_total_fee', totalFee.toFixed(2));

  // ===== ฟังก์ชันคิดเงินต่อวัน =====
  function calcDailyFee(hours) {
    if (!hours || hours <= 0) return 0;

    // 8-24 ชั่วโมง เหมา 200
    if (hours > 8) return 200;

    var fee = 0;

    // 0-1 ชั่วโมงแรก ชั่วโมงละ 10
    fee += 10;

    // 1-4 ชั่วโมง ชั่วโมงละ 15 (ชั่วโมงที่ 2-4 = 3 ชั่วโมง)
    if (hours > 1) {
      var h15 = Math.min(hours, 4) - 1; // 2..4
      fee += h15 * 15;
    }

    // 4-8 ชั่วโมง ชั่วโมงละ 20 (ชั่วโมงที่ 5-8)
    if (hours > 4) {
      var h20 = Math.min(hours, 8) - 4; // 5..8
      fee += h20 * 20;
    }

    return fee;
  }
}
]]></script>
        <sys_class_name>catalog_script_client</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-15 02:44:56</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>7f31c98a833d72100e72b1b6feaad35c</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Total Fee (Baht) End Date/Time</sys_name>
        <sys_overrides/>
        <sys_package display_value="Car Parking Reservation" source="x_1869632_car_pa_0">b7a60b46832576100e72b1b6feaad377</sys_package>
        <sys_policy/>
        <sys_scope display_value="Car Parking Reservation">b7a60b46832576100e72b1b6feaad377</sys_scope>
        <sys_update_name>catalog_script_client_7f31c98a833d72100e72b1b6feaad35c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-15 02:44:56</sys_updated_on>
        <table/>
        <type>onChange</type>
        <ui_type>10</ui_type>
        <va_supported>true</va_supported>
        <variable_set/>
        <view/>
    </catalog_script_client>
</record_update>
